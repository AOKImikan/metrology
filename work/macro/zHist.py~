#!/usr/bin/env python3
import os
import pickle
import sys
import tkinter as tk
from tkinter import ttk
import pmm
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt

def plotPoint(scanData, anaData, tagName):    
    #group scandata dataframe by tags
    grouptag = scanData.groupby(['tags'])
   
    #extract by specified tag
    extractData = grouptag.get_group((tagName[1]))
    #print(extractData)

    #group analysis data by tags
    grouptag_ana = anaData.groupby(['tags'])
    #extract by specified tag
    extractData_ana = grouptag_ana.get_group((tagName[1]))
    
    #define matplotlib figure
    fig = plt.figure(figsize=(10,9))
    ax = fig.add_subplot(1,1,1)

    ax.set_title(tagName[1])
    #set image edge
    dx=0.57
    dy=0.38
    right = extractData['x'].iloc[1]+dx
    left = extractData['x'].iloc[1]-dx
    top = extractData['y'].iloc[1]+dy
    botom = extractData['y'].iloc[1]-dy

    #set plot area
    #set image edge
    dx=0.57
    dy=0.38
    right = extractData['x'].iloc[1]+dx
    left = extractData['x'].iloc[1]-dx
    top = extractData['y'].iloc[1]+dy
    botom = extractData['y'].iloc[1]-dy
    ax.axvline(right, color="#00ff00",lw=2)
    ax.axvline(left, color="#00ff00",lw=2)
    ax.axhline(top, color="#00ff00",lw=2)
    ax.axhline(botom, color="#00ff00",lw=2)
    #image center
    ax.scatter(extractData['x'].iloc[1],extractData['y'].iloc[1],color="#00a0ff")

    #plot
    NGsn = extractLargeZ(scanData,tagName)
    for sn in extractData_ana['serialnumber']:
        name = 'serialnumber==\"{}\"'.format(sn)
        
        print(extractData_ana.loc[extractData_ana.query(name).index[0], 'detect_x'])
        x = extractData_ana.loc[extractData_ana.query(name).index[0], 'detect_x']
        y = extractData_ana.loc[extractData_ana.query(name).index[0], 'detect_y']

        if sn==NGsn:
            ax.scatter(x,y,color="#ff0000")
        else:
            ax.scatter(x,y,color="#4da500")
    ax.scatter(extractData_ana['detect_x'].iloc[0],extractData_ana['detect_y'].iloc[0],color="#ff0000")
    ax.scatter(extractData_ana['detect_x'].iloc[1],extractData_ana['detect_y'].iloc[1],color="#ff0000")
    ax.scatter(extractData_ana['detect_x'].iloc[2],extractData_ana['detect_y'].iloc[2],color="#ff0000")
    ax.scatter(extractData_ana['detect_x'].iloc[3],extractData_ana['detect_y'].iloc[3],color="#ff0000")
    ax.scatter(extractData_ana['detect_x'].iloc[4],extractData_ana['detect_y'].iloc[4],color="#ff0000")
    ax.scatter(extractData_ana['detect_x'].iloc[5],extractData_ana['detect_y'].iloc[5],color="#ff0000")
   
    plt.show()
    
def extractMargin(scandata, analydata):
    serialnum=[]
    for k,v in analydata.items():
        serialnum.append(k)

    ###################
    SN=serialnum[0]
    pointName = 'AsicFmark'
    lineName = 'Flex'
    ###################
    
    plotPoint(SN, pointName, scandata, analydata)

#show all tags std hist
def HistStd(scanData):
    #group scandata dataframe by tags
    grouptag = scanData.groupby(['tags'])
    #get std x,y,z
    stdDF = grouptag.std()
    #get std z
    stdlist = stdDF['z']

    #define matplotlib figure
    fig = plt.figure(figsize=(10,9))
    ax = fig.add_subplot(1,1,1)
    #fill std list 
    ax.hist(stdlist, bins=50)

    ax.set_title('scan data z standard deviation')
    ax.set_xlabel('std')
    ax.set_ylabel('number of tags')
    #show hist
    plt.show()

def extractStd(scanData, threshold):
    #group scandata dataframe by tags
    grouptag = scanData.groupby(['tags'])
    #get std x,y,z
    stdDF = grouptag.std()

    largeStd = stdDF[stdDF.z > threshold]
    print(largeStd)  
    
def extractLargeZ(scanData,tag):
    #group scandata dataframe by tags
    pltdata = scanData.groupby(['tags'])
    #extract by specified tag
    extractData = pltdata.get_group((tag[1]))

    #get standard deviation
    std = extractData['z'].std()
    mean = extractData['z'].mean()
    print('std = ',std)

    #define return list
    NGSN = []
    
    #extractData 1 row roop
    i = 0
    while i<len(extractData):
        #extract 1 row (dataframe -> series)
        rowi = extractData.iloc[i]
        # z > standard deviation?
        if abs(rowi['z']-mean) > 0.03:
            #print NG serial number
            print('NG SN ', rowi['serialnumber'])
            NGSN.append(rowi['serialnumber'])
        i += 1
    return NGSN
    
def run(scanData, anaData, tag):
    #extractMargin(scanData, anaData)
    #extractLargeZ(scanData,tag)
    #extractStd(scanData, 0.03)
    #HistStd(scanData)
    plotPoint(scanData, anaData, tag)
    
if __name__ == '__main__':
    tag = sys.argv
    with open(f'data/ScanData.pkl', 'rb') as fin:
        scanData = pickle.load(fin)
    with open(f'data/AnalysisData.pkl', 'rb') as fin:
        analysisData = pickle.load(fin)
        
    run(scanData, analysisData, tag)    
