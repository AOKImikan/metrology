#!/usr/bin/env python3
import os
import pickle
import tkinter as tk
from tkinter import ttk
import pmm
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt

#data.pickle -> ScanProcessor
def LoadData(dn):
    appdata = None
    if os.path.exists(dn):
        with open(f'{dn}/data.pickle', 'rb') as fin:
            appdata = pickle.load(fin)
            appdata = appdata.deserialize()
    if appdata:
        sp = appdata.getScanProcessor('ITkPixV1xModule.Size')
    return sp

#analysis -> dataframe
def analyDataCnvDataFrame(SN,qcnum,dn):
    sp =LoadData(dn)
    patternAnalysis = sp.analysisList[0]
    sizeAnalysis = sp.analysisList[1]
    xlist, ylist,tags = [],[],[]
    sn, qc = [],[]
    for k,v in patternAnalysis.outData.items():
        if('point'in k):
            key = k.split('_')
            tag = key[0]
            sn.append(SN)
            qc.append(qcnum)
            tags.append(tag)
            xlist.append(v.position[0])
            ylist.append(v.position[1])
            
    #for k,v in sizeAnalysis.outData.items():

    #make dataframe with serial number
    df=pd.DataFrame({'serialnumber':sn})
    #add data to dataframe
    df['qc_stage']=qc
    df['tags']=tags
    df['detect_x']=xlist
    df['detect_y']=ylist
    
    return df

#scanData -> dataframe
def scanPointCnvDataframe(SN,qcnum,dn):
    sn, qc = [],[]
    scanList_x ,scanList_y, scanList_z, scanList_tags,scanList_imPath = [],[],[],[],[]
    sp = LoadData(dn)
    i = 0
    while i < len(sp.scanData.points):
        point = sp.scanData.points[i]
        sn.append(SN)
        qc.append(qcnum)
        scanList_x.append(point.get('x'))
        scanList_y.append(point.get('y'))
        scanList_z.append(point.get('z'))
        scanList_tags.append(point.get('tags')[0])
        scanList_imPath.append(point.get('imagePath'))
        i += 1
        
    #define dataframe with serial number
    df=pd.DataFrame({'serialnumber':sn})
    #add data to dataframe
    df['qc_stage']=qc
    df['x']=scanList_x
    df['y']=scanList_y
    df['z']=scanList_z
    df['tags']=scanList_tags
    df['imagePath']=scanList_imPath
    
    return df

#get serial number from directory path
def extractSN(dn):
    words = dn.split('/')
    print('SN = ',words[9])
    return words[9]

#get QC stage and Metrology number from directory path
def extractQcStage(dn):
    words = dn.split('/')
    qcstage = words[10]+"/"+words[11]
    print("qcStage=",qcstage)
    return qcstage

def run(dnames):
    #define the aimed dataframe
    scanDFs = pd.DataFrame()
    analyDFs = pd.DataFrame()

    #repeat for each serial number
    for dn in dnames:
        #get serial number and qc stage
        sn = extractSN(dn)
        qcstage = extractQcStage(dn)

        #convert from pickle to dataframe
        analydf = analyDataCnvDataFrame(sn,qcstage,dn)        
        scandf = scanPointCnvDataframe(sn,qcstage,dn)

        #concat each serial numbers
        analyDFs = pd.concat([analyDFs,analydf])
        scanDFs = pd.concat([scanDFs,scandf])

    #save the created data
    analyDFs.to_pickle("data/AnalysisData.pkl")
    scanDFs.to_pickle("data/ScanData.pkl")
    analyDFs.to_csv("data/AnalysisData.csv")
    scanDFs.to_csv("data/ScanData.csv")

    print("save data file")

if __name__ == '__main__':
    dnames = [
        '/nfs/space3/tkohno/atlas/ITkPixel/Metrology/HR/MODULE/20UPGM22601020/MODULE_ASSEMBLY/003',
        '/nfs/space3/tkohno/atlas/ITkPixel/Metrology/HR/MODULE/20UPGM22601015/MODULE_ASSEMBLY/002',
        '/nfs/space3/tkohno/atlas/ITkPixel/Metrology/HR/MODULE/20UPGM22601016/MODULE_ASSEMBLY/002',
        '/nfs/space3/tkohno/atlas/ITkPixel/Metrology/HR/MODULE/20UPGM22110427/MODULE_ASSEMBLY/004',
        '/nfs/space3/tkohno/atlas/ITkPixel/Metrology/HR/MODULE/20UPGM22101021/MODULE_ASSEMBLY/001',
        '/nfs/space3/tkohno/atlas/ITkPixel/Metrology/HR/MODULE/20UPGM22601021/MODULE_ASSEMBLY/003'
    ]   
    run(dnames)
